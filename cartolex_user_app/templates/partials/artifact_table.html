<!-- Table Artifact Renderer -->
<div class="artifact-content" x-data="{
    rows: {{ artifact.data.table | tojson | safe }},
    searchTerm: '',
    sortColumn: null,
    sortDirection: 'asc',
    currentPage: 1,
    pageSize: 25,

    get columns() {
        return this.rows.length > 0 ? Object.keys(this.rows[0]) : [];
    },

    get filteredRows() {
        if (!this.searchTerm) return this.rows;
        const search = this.searchTerm.toLowerCase();
        return this.rows.filter(row =>
            Object.values(row).some(value => String(value).toLowerCase().includes(search))
        );
    },

    get sortedRows() {
        if (!this.sortColumn) return this.filteredRows;
        return [...this.filteredRows].sort((a, b) => {
            let aVal = a[this.sortColumn];
            let bVal = b[this.sortColumn];
            if (aVal == null) return 1;
            if (bVal == null) return -1;
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            }
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
            return this.sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
    },

    get paginatedRows() {
        const start = (this.currentPage - 1) * this.pageSize;
        return this.sortedRows.slice(start, start + this.pageSize);
    },

    get totalPages() {
        return Math.ceil(this.sortedRows.length / this.pageSize);
    },

    get startRow() {
        return (this.currentPage - 1) * this.pageSize + 1;
    },

    get endRow() {
        return Math.min(this.currentPage * this.pageSize, this.sortedRows.length);
    },

    sortBy(column) {
        if (this.sortColumn === column) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortColumn = column;
            this.sortDirection = 'asc';
        }
    },

    nextPage() {
        if (this.currentPage < this.totalPages) this.currentPage++;
    },

    prevPage() {
        if (this.currentPage > 1) this.currentPage--;
    },

    formatCell(value) {
        if (value === null || value === undefined) return '-';
        if (typeof value === 'boolean') return value ? '✓' : '✗';
        if (typeof value === 'object') return JSON.stringify(value);
        return value;
    },

    exportCSV() {
        const csv = [
            this.columns.join(','),
            ...this.sortedRows.map(row =>
                this.columns.map(col => {
                    const val = row[col];
                    const str = val === null || val === undefined ? '' : String(val);
                    return str.includes(',') ? `\"${str}\"` : str;
                }).join(',')
            )
        ].join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '{{ artifact.key }}.csv';
        a.click();
        URL.revokeObjectURL(url);
    }
}">
    <div class="flex items-center justify-between mb-4 pb-3 border-b esevioz-border-dominant">
        <div>
            <h4 class="text-lg font-medium esevioz-text">{{ artifact.key }}</h4>
            <p class="text-sm esevioz-text opacity-60 mt-1">{{ artifact.description }}</p>
            <p class="text-xs esevioz-text opacity-50 mt-1">
                <span x-text="filteredRows.length"></span> rows
                <template x-if="filteredRows.length !== rows.length">
                    <span>of <span x-text="rows.length"></span> total</span>
                </template>
            </p>
        </div>
        <div class="flex items-center gap-2">
            <button @click="exportCSV()" class="px-3 py-1 text-sm rounded esevioz-btn-secondary">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                </svg>
                Export CSV
            </button>
            <span class="px-3 py-1 text-xs font-medium rounded esevioz-badge-info">Table</span>
        </div>
    </div>

    <!-- Search/Filter -->
    <div class="mb-4">
        <input type="search"
               x-model="searchTerm"
               placeholder="Search table..."
               class="w-full px-3 py-2 border esevioz-border-dominant rounded-md esevioz-input text-sm">
    </div>

    <!-- Table -->
    <div class="overflow-x-auto rounded-lg border esevioz-border-dominant">
        <table class="min-w-full divide-y esevioz-border-dominant">
            <thead class="esevioz-bg-pine-light">
                <tr>
                    <template x-for="(column, index) in columns" :key="column">
                        <th scope="col"
                            class="px-4 py-3 text-left text-xs font-medium esevioz-text uppercase tracking-wider cursor-pointer hover:bg-opacity-80"
                            @click="sortBy(column)">
                            <div class="flex items-center">
                                <span x-text="column"></span>
                                <svg x-show="sortColumn === column && sortDirection === 'asc'"
                                     class="ml-1 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <svg x-show="sortColumn === column && sortDirection === 'desc'"
                                     class="ml-1 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </th>
                    </template>
                </tr>
            </thead>
            <tbody class="esevioz-card divide-y esevioz-border-dominant">
                <template x-for="(row, rowIndex) in paginatedRows" :key="rowIndex">
                    <tr class="hover:bg-opacity-50 hover:esevioz-bg-pine-light transition-colors">
                        <template x-for="(column, colIndex) in columns" :key="colIndex">
                            <td class="px-4 py-3 text-sm esevioz-text whitespace-nowrap">
                                <span x-text="formatCell(row[column])"></span>
                            </td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex items-center justify-between">
        <div class="text-sm esevioz-text opacity-75">
            Showing <span x-text="startRow"></span> to <span x-text="endRow"></span>
        </div>
        <div class="flex items-center gap-2">
            <button @click="prevPage()"
                    :disabled="currentPage === 1"
                    class="px-3 py-1 text-sm rounded esevioz-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <span class="text-sm esevioz-text">
                Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
            </span>
            <button @click="nextPage()"
                    :disabled="currentPage === totalPages"
                    class="px-3 py-1 text-sm rounded esevioz-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>

    <!-- Metadata -->
    {% if artifact.metadata %}
    <div class="mt-6 pt-4 border-t esevioz-border-dominant">
        <details class="text-sm">
            <summary class="cursor-pointer esevioz-text opacity-75 hover:opacity-100 font-medium">Metadata</summary>
            <div class="mt-2 esevioz-card rounded p-3">
                <pre class="text-xs font-mono esevioz-text opacity-75 overflow-x-auto">{{ artifact.metadata | tojson(indent=2) }}</pre>
            </div>
        </details>
    </div>
    {% endif %}
</div>
