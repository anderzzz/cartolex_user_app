<!-- Workflow Configuration Expansion Panel -->
<div id="config-{{ workflow_name }}" class="border-t esevioz-border-dominant px-6 py-4 esevioz-bg-accent" x-data="{ saving: false }">
    <form hx-put="{{ url_for('workflows.update_workflow_config', workflow_name=workflow_name) }}"
          hx-target="#config-save-result-{{ workflow_name }}"
          hx-swap="innerHTML"
          @htmx:before-request="saving = true"
          @htmx:after-request="saving = false"
          class="space-y-6">
        
        <!-- Configuration Header -->
        <div class="flex items-center justify-between">
            <div>
                <h4 class="text-lg font-medium esevioz-text">Workflow Configuration</h4>
                <p class="text-sm esevioz-text opacity-75">Source: {{ config_source }}</p>
            </div>
            <button type="button" 
                    onclick="closeWorkflowConfig('{{ workflow_name }}')"
                    class="text-sm esevioz-text opacity-75 hover:opacity-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Workflow Basic Info (Read-only) -->
        {% if config.description %}
        <div>
            <label class="block text-sm font-medium esevioz-text mb-2">Description</label>
            <div class="p-3 esevioz-bg rounded-md border esevioz-border-dominant">
                <p class="text-sm esevioz-text opacity-75">{{ config.description }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Workflow Launcher Section -->
        {% if config.workflow_launcher %}
        <div class="space-y-4">
            <h5 class="text-md font-medium esevioz-text border-b esevioz-border-dominant pb-2">Launcher Configuration</h5>
            
            <!-- Launcher Name (Read-only) -->
            <div>
                <label class="block text-sm font-medium esevioz-text mb-2">Launcher Type</label>
                <div class="p-3 esevioz-bg rounded-md border esevioz-border-dominant">
                    <p class="text-sm esevioz-text opacity-75">{{ config.workflow_launcher.launcher_name or 'Not specified' }}</p>
                </div>
            </div>

            <!-- Launcher Parameters (Editable) -->
            {% if config.workflow_launcher.launcher_params %}
            <div>
                <label class="block text-sm font-medium esevioz-text mb-3">Launcher Parameters</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for param_name, param_value in config.workflow_launcher.launcher_params.items() %}
                    <div>
                        <label for="launcher_param_{{ param_name }}" class="block text-sm font-medium esevioz-text">
                            {{ param_name.replace('_', ' ').title() }}
                        </label>
                        <input type="text"
                               id="launcher_param_{{ param_name }}"
                               name="launcher_param_{{ param_name }}"
                               value="{{ param_value | to_form_value }}"
                               placeholder="{% if param_value is iterable and param_value is not string %}JSON format: arrays like [&quot;item1&quot;,&quot;item2&quot;], objects like {&quot;key&quot;:&quot;value&quot;}{% endif %}"
                               class="mt-1 block w-full esevioz-input rounded-md shadow-sm sm:text-sm">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Workflow Lander Section -->
        {% if config.workflow_lander %}
        <div class="space-y-4">
            <h5 class="text-md font-medium esevioz-text border-b esevioz-border-dominant pb-2">Lander Configuration</h5>
            
            <!-- Lander Name (Read-only) -->
            <div>
                <label class="block text-sm font-medium esevioz-text mb-2">Lander Type</label>
                <div class="p-3 esevioz-bg rounded-md border esevioz-border-dominant">
                    <p class="text-sm esevioz-text opacity-75">{{ config.workflow_lander.lander_name or 'Not specified' }}</p>
                </div>
            </div>

            <!-- Lander Parameters (Editable) -->
            {% if config.workflow_lander.lander_params %}
            <div>
                <label class="block text-sm font-medium esevioz-text mb-3">Lander Parameters</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for param_name, param_value in config.workflow_lander.lander_params.items() %}
                    <div>
                        <label for="lander_param_{{ param_name }}" class="block text-sm font-medium esevioz-text">
                            {{ param_name.replace('_', ' ').title() }}
                        </label>
                        <input type="text"
                               id="lander_param_{{ param_name }}"
                               name="lander_param_{{ param_name }}"
                               value="{{ param_value | to_form_value }}"
                               placeholder="{% if param_value is iterable and param_value is not string %}JSON format: arrays like [&quot;item1&quot;,&quot;item2&quot;], objects like {&quot;key&quot;:&quot;value&quot;}{% endif %}"
                               class="mt-1 block w-full esevioz-input rounded-md shadow-sm sm:text-sm">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3 pt-4 border-t esevioz-border-dominant">
            <button type="button" 
                    onclick="closeWorkflowConfig('{{ workflow_name }}')"
                    class="px-4 py-2 text-sm font-medium rounded-md esevioz-btn-secondary">
                Cancel
            </button>
            <button type="submit" 
                    :disabled="saving"
                    class="px-4 py-2 text-sm font-medium rounded-md esevioz-btn-primary disabled:opacity-50">
                <svg x-show="saving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-current" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="saving ? 'Saving...' : 'Save Configuration'"></span>
            </button>
        </div>

        <!-- Save Result Area -->
        <div id="config-save-result-{{ workflow_name }}" class="mt-4"></div>
    </form>
</div>

<script>
    // Global function to close workflow configuration
    window.closeWorkflowConfig = function(workflowName) {
        // Method 1: Dispatch a custom event that the Alpine component can listen to
        window.dispatchEvent(new CustomEvent('close-workflow-config', {
            detail: { workflowName: workflowName }
        }));

        // Method 2: Fallback - directly clear the content
        const configElement = document.getElementById('workflow-' + workflowName + '-config');
        if (configElement) {
            configElement.innerHTML = '';
        }
    };

    // JSON validation helper for parameter inputs
    function validateJSONInput(input) {
        const value = input.value.trim();

        // Skip validation for empty values or simple strings not starting with [ or {
        if (!value || (!value.startsWith('[') && !value.startsWith('{'))) {
            input.classList.remove('border-red-500', 'border-green-500');
            return;
        }

        try {
            JSON.parse(value);
            // Valid JSON - show green border
            input.classList.remove('border-red-500');
            input.classList.add('border-green-500');
        } catch (e) {
            // Invalid JSON - show red border
            input.classList.remove('border-green-500');
            input.classList.add('border-red-500');
        }
    }

    // Add event listeners when the config panel loads
    document.addEventListener('DOMContentLoaded', function() {
        // Find all parameter inputs and add validation
        const paramInputs = document.querySelectorAll('input[name^="launcher_param_"], input[name^="lander_param_"]');
        paramInputs.forEach(input => {
            input.addEventListener('input', () => validateJSONInput(input));
            input.addEventListener('blur', () => validateJSONInput(input));
        });
    });
</script>