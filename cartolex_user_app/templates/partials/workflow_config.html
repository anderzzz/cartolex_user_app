<!-- Workflow Configuration Expansion Panel -->
<div id="config-{{ workflow_name }}" class="border-t esevioz-border-dominant px-6 py-4 esevioz-bg-accent" x-data="{ saving: false }">
    <form hx-put="{{ url_for('workflows.update_workflow_config', workflow_name=workflow_name) }}"
          hx-target="#config-save-result-{{ workflow_name }}"
          hx-swap="innerHTML"
          @htmx:before-request="saving = true"
          @htmx:after-request="saving = false"
          class="space-y-6">

        <!-- Configuration Header -->
        <div class="flex items-center justify-between">
            <div>
                <h4 class="text-lg font-medium esevioz-text">Workflow Configuration</h4>
                <p class="text-sm esevioz-text opacity-75">Source: {{ config_source }}</p>
            </div>
            <button type="button"
                    onclick="closeWorkflowConfig('{{ workflow_name }}')"
                    class="text-sm esevioz-text opacity-75 hover:opacity-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Lock Status Indicator -->
        {% if config._schema and config._schema.locked %}
        <div class="mt-4 mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-yellow-600 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm font-medium text-yellow-800">
                    This configuration is locked and cannot be modified
                </span>
            </div>
        </div>
        {% endif %}

        <!-- Workflow Kind (Read-only) -->
        {% if config.workflow_kind %}
        <div>
            <label class="block text-sm font-medium esevioz-text mb-2">Workflow Kind</label>
            <div class="p-3 esevioz-bg rounded-md border esevioz-border-dominant">
                <p class="text-sm esevioz-text opacity-75">{{ config.workflow_kind }}</p>
            </div>
            <p class="mt-1 text-xs esevioz-text opacity-60">The type of workflow to execute (read-only)</p>
        </div>
        {% endif %}

        <!-- Description (Read-only) -->
        {% if config.description %}
        <div>
            <label class="block text-sm font-medium esevioz-text mb-2">Description</label>
            <div class="p-3 esevioz-bg rounded-md border esevioz-border-dominant">
                <p class="text-sm esevioz-text opacity-75">{{ config.description }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Workflow Parameters Section -->
        {% if config.parameters %}
        <div class="space-y-4">
            <h5 class="text-md font-medium esevioz-text border-b esevioz-border-dominant pb-2">Workflow Parameters</h5>

            <!-- Parameters Grid -->
            <div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for param_name, param_value in config.parameters.items() %}
                    {% set editable_paths = config._schema.editable_paths if config._schema else [] %}
                    {% set is_editable = 'parameters.*' in editable_paths or ('parameters.' + param_name) in editable_paths %}
                    {% set is_locked = config._schema.locked if config._schema else false %}
                    {% set field_disabled = is_locked or not is_editable %}

                    <div>
                        <label for="param_{{ param_name }}" class="block text-sm font-medium esevioz-text">
                            {{ param_name.replace('_', ' ').title() }}
                            {% if not is_editable %}
                                <span class="text-xs opacity-60">(read-only)</span>
                            {% endif %}
                        </label>
                        <input type="text"
                               id="param_{{ param_name }}"
                               name="param_{{ param_name }}"
                               value="{{ param_value | to_form_value }}"
                               placeholder="{% if param_value is iterable and param_value is not string %}JSON format: arrays like [&quot;item1&quot;,&quot;item2&quot;], objects like {&quot;key&quot;:&quot;value&quot;}{% endif %}"
                               {% if field_disabled %}disabled{% endif %}
                               class="mt-1 block w-full esevioz-input rounded-md shadow-sm sm:text-sm {% if field_disabled %}bg-gray-50 cursor-not-allowed opacity-75{% endif %}"
                               data-param-name="{{ param_name }}">
                        {% if not is_editable and not is_locked %}
                        <p class="mt-1 text-xs esevioz-text opacity-60">This parameter is not editable according to the schema</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-8 esevioz-bg rounded-md border esevioz-border-dominant">
            <p class="text-sm esevioz-text opacity-75">No parameters configured for this workflow</p>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3 pt-4 border-t esevioz-border-dominant">
            <button type="button"
                    onclick="closeWorkflowConfig('{{ workflow_name }}')"
                    class="px-4 py-2 text-sm font-medium rounded-md esevioz-btn-secondary">
                Cancel
            </button>
            <button type="submit"
                    :disabled="saving{% if config._schema and config._schema.locked %} || true{% endif %}"
                    class="px-4 py-2 text-sm font-medium rounded-md esevioz-btn-primary disabled:opacity-50 disabled:cursor-not-allowed">
                <svg x-show="saving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-current" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="saving ? 'Saving...' : 'Save Configuration'"></span>
            </button>
        </div>

        <!-- Save Result Area -->
        <div id="config-save-result-{{ workflow_name }}" class="mt-4"></div>
    </form>
</div>

<script>
    // Global function to close workflow configuration
    window.closeWorkflowConfig = function(workflowName) {
        // Method 1: Dispatch a custom event that the Alpine component can listen to
        window.dispatchEvent(new CustomEvent('close-workflow-config', {
            detail: { workflowName: workflowName }
        }));

        // Method 2: Fallback - directly clear the content
        const configElement = document.getElementById('workflow-' + workflowName + '-config');
        if (configElement) {
            configElement.innerHTML = '';
        }
    };

    // JSON validation helper for parameter inputs
    function validateJSONInput(input) {
        const value = input.value.trim();

        // Skip validation for empty values or simple strings not starting with [ or {
        if (!value || (!value.startsWith('[') && !value.startsWith('{'))) {
            input.classList.remove('border-red-500', 'border-green-500');
            return;
        }

        try {
            JSON.parse(value);
            // Valid JSON - show green border
            input.classList.remove('border-red-500');
            input.classList.add('border-green-500');
        } catch (e) {
            // Invalid JSON - show red border
            input.classList.remove('border-green-500');
            input.classList.add('border-red-500');
        }
    }

    // Add event listeners when the config panel loads
    document.addEventListener('DOMContentLoaded', function() {
        // Find all parameter inputs and add validation
        const paramInputs = document.querySelectorAll('input[name^="param_"]');
        paramInputs.forEach(input => {
            input.addEventListener('input', () => validateJSONInput(input));
            input.addEventListener('blur', () => validateJSONInput(input));
        });
    });
</script>
