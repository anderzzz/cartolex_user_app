{% extends "base.html" %}

{% block title %}{{ page_title or 'Canvas - Cartolex' }}{% endblock %}

{% block content %}
<!-- Canvas CSS -->
{% if not canvas_dev_mode %}
<link rel="stylesheet" href="{{ url_for('static', filename='canvas/style.css') }}">
{% endif %}

<div class="px-4 sm:px-0">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-semibold esevioz-text">Canvas</h1>
        <p class="mt-1 text-sm esevioz-text opacity-60">
            Visual workspace for workflow design and experimentation
        </p>
    </div>

    <!-- Canvas Container -->
    <div class="esevioz-card rounded-lg overflow-hidden" style="height: calc(100vh - 220px); min-height: 500px;">
        <div id="canvas-root" style="width: 100%; height: 100%;"></div>
    </div>
</div>

<!-- Canvas Module Script -->
{% if canvas_dev_mode %}
<!-- Development: Load Vite client and React preamble first -->
<script type="module" src="http://localhost:5173/@vite/client"></script>
<script type="module">
    import RefreshRuntime from 'http://localhost:5173/@react-refresh'
    RefreshRuntime.injectIntoGlobalHook(window)
    window.$RefreshReg$ = () => {}
    window.$RefreshSig$ = () => (type) => type
    window.__vite_plugin_react_preamble_installed__ = true
</script>
<!-- Development: Load from Vite dev server -->
<script type="module">
    import { mountCanvas } from 'http://localhost:5173/src/index.tsx'

    document.addEventListener('DOMContentLoaded', function() {
        try {
            const canvas = mountCanvas({
                containerId: 'canvas-root',
                onSave: (graph) => {
                    console.log('Canvas graph saved:', graph)
                }
            })

            // Expose API globally for debugging
            window.canvasAPI = canvas
        } catch (error) {
            console.error('Failed to mount canvas:', error)
            document.getElementById('canvas-root').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center esevioz-text">
                        <p class="text-lg font-medium mb-2">Canvas failed to load</p>
                        <p class="text-sm opacity-60">Make sure the Vite dev server is running:</p>
                        <code class="mt-2 block text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded">cd canvas && npm run dev</code>
                    </div>
                </div>
            `
        }
    })
</script>
{% else %}
<!-- Production: Load built bundle -->
<script type="module">
    import { mountCanvas } from '{{ url_for("static", filename="canvas/cartolex-canvas.js") }}'

    document.addEventListener('DOMContentLoaded', function() {
        try {
            const canvas = mountCanvas({
                containerId: 'canvas-root',
                onSave: (graph) => {
                    console.log('Canvas graph saved:', graph)
                }
            })

            // Expose API globally for debugging
            window.canvasAPI = canvas
        } catch (error) {
            console.error('Failed to mount canvas:', error)
            document.getElementById('canvas-root').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center esevioz-text">
                        <p class="text-lg font-medium mb-2">Canvas failed to load</p>
                        <p class="text-sm opacity-60">The canvas bundle may not be built. Run:</p>
                        <code class="mt-2 block text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded">cd canvas && npm run build</code>
                    </div>
                </div>
            `
        }
    })
</script>
{% endif %}
{% endblock %}
