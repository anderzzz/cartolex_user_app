{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data='{
    expandedWorkflows: {},
    workflows: {{ workflows|tojson|safe }},
    searchTerm: "",
    get filteredWorkflows() {
        if (!this.searchTerm || this.searchTerm.trim() === "") {
            return this.workflows;
        }
        const search = this.searchTerm.toLowerCase();
        return this.workflows.filter(w =>
            w.name.toLowerCase().includes(search) ||
            (w.description && w.description.toLowerCase().includes(search)) ||
            (w.workflow_kind && w.workflow_kind.toLowerCase().includes(search))
        );
    },
    init() {
        // Listen for workflow mutation events to refresh list
        window.addEventListener("workflow-cloned", () => {
            // Workflow list will be refreshed by HTMX
            this.expandedWorkflows = {};
        });
        window.addEventListener("workflow-deleted", () => {
            // Workflow list will be refreshed by HTMX
            this.expandedWorkflows = {};
        });
    }
}'>
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">Workflows</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Configure, clone, and launch workflow configurations
        </p>
    </div>

    <!-- Search Bar -->
    {% if workflows and workflows|length > 3 %}
    <div class="mb-6">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input type="search"
                   x-model="searchTerm"
                   placeholder="Search workflows by name, description, or type..."
                   class="block w-full pl-10 pr-3 py-2 border esevioz-border-dominant rounded-md esevioz-input text-sm">
            <div x-show="searchTerm" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <button @click="searchTerm = ''" type="button" class="esevioz-text opacity-50 hover:opacity-100">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <p x-show="searchTerm && filteredWorkflows.length === 0"
           class="mt-2 text-sm esevioz-text opacity-60">
            No workflows match "<span x-text="searchTerm"></span>"
        </p>
        <p x-show="searchTerm && filteredWorkflows.length > 0"
           class="mt-2 text-xs esevioz-text opacity-50">
            Showing <span x-text="filteredWorkflows.length"></span> of <span x-text="workflows.length"></span> workflows
        </p>
    </div>
    {% endif %}

    <!-- Workflow Cards -->
    <div class="mb-8" id="workflow-list-container">
        <template x-if="filteredWorkflows.length > 0">
            <div class="grid gap-4">
                <template x-for="workflow in filteredWorkflows" :key="workflow.name">
                    <div class="esevioz-card esevioz-shadow rounded-lg esevioz-workflow-card-hover">
                        <!-- Clickable Workflow Header -->
                        <div class="px-6 py-4 cursor-pointer rounded-t-lg"
                             @click="if (!expandedWorkflows[workflow.name]) {
                                       htmx.ajax('GET', `/workflows/${workflow.name}/summary`, {
                                           target: `#workflow-${workflow.name}-summary`,
                                           swap: 'innerHTML'
                                       });
                                       expandedWorkflows[workflow.name] = true;
                                     } else {
                                       expandedWorkflows[workflow.name] = false;
                                       document.getElementById(`workflow-${workflow.name}-summary`).innerHTML = '';
                                     }">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h4 class="text-lg font-medium esevioz-text" x-text="workflow.name"></h4>
                                        <!-- Expand/Collapse Chevron -->
                                        <svg class="ml-2 w-5 h-5 esevioz-text transition-transform"
                                             :class="{ 'transform rotate-180': expandedWorkflows[workflow.name] }"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                    <p class="mt-1 text-sm esevioz-text opacity-75" x-text="workflow.description || 'No description available'"></p>
                                    <div class="mt-2 flex items-center space-x-4 text-xs esevioz-text opacity-60">
                                        <span x-text="workflow.workflow_kind"></span>
                                        <template x-if="workflow.last_modified">
                                            <span>â€¢ Modified <span x-text="workflow.last_modified"></span></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expandable Summary Area -->
                        <div :id="`workflow-${workflow.name}-summary`"
                             x-show="expandedWorkflows[workflow.name]"
                             x-collapse>
                            <!-- Summary content loads here via HTMX -->
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Empty State (No Workflows) -->
        <template x-if="workflows.length === 0">
            <div class="text-center py-12 esevioz-card rounded-lg">
                <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.712-3.714M14 40v-4a9.971 9.971 0 01.712-3.714M28 16a4 4 0 11-8 0 4 4 0 018 0zM24 20v6M8 16a4 4 0 11-8 0 4 4 0 018 0zM8 20v6m32-6a4 4 0 11-8 0 4 4 0 018 0zM40 20v6" />
                </svg>
                <h3 class="mt-2 text-sm font-medium esevioz-text">No workflows available</h3>
                <p class="mt-1 text-sm esevioz-text opacity-75">Check your backend connection and configuration.</p>
            </div>
        </template>
    </div>

    <!-- Monitoring Section -->
    <div>
        {% include 'partials/workflow_monitor.html' %}
    </div>
</div>
{% endblock %}