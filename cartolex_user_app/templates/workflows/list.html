{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="{ 
    openConfigs: {},
    init() {
        // Listen for the close event from the configuration panel
        window.addEventListener('close-workflow-config', (event) => {
            const workflowName = event.detail.workflowName;
            this.openConfigs[workflowName] = false;
            // Also clear the content
            const configElement = document.getElementById('workflow-' + workflowName + '-config');
            if (configElement) {
                configElement.innerHTML = '';
            }
        });
    }
}">
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">Workflows</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Configure, execute, and monitor workflows
        </p>
    </div>

    <!-- Available Workflows Section -->
    <div class="mb-8">
        <h3 class="text-lg font-medium esevioz-text mb-4">Available Workflows</h3>
        
        {% if workflows %}
            <div class="grid gap-4">
                {% for workflow in workflows %}
                    <div class="esevioz-card esevioz-shadow rounded-lg">
                        <!-- Workflow Header -->
                        <div class="px-6 py-4 border-b esevioz-border-dominant">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="text-lg font-medium esevioz-text">{{ workflow.name }}</h4>
                                    <p class="mt-1 text-sm esevioz-text opacity-75">{{ workflow.description or 'No description available' }}</p>
                                    {% if workflow.workflow_kind %}
                                        <div class="mt-2 flex items-center space-x-4 text-xs esevioz-text opacity-60">
                                            <span>Workflow Kind: {{ workflow.workflow_kind }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Expand/Collapse Button -->
                                <button type="button" 
                                        @click="if (!openConfigs['{{ workflow.name }}']) {
                                                  htmx.ajax('GET', '{{ url_for('workflows.get_workflow_config', workflow_name=workflow.name) }}', {
                                                    target: '#workflow-{{ workflow.name }}-config',
                                                    swap: 'innerHTML'
                                                  });
                                                  openConfigs['{{ workflow.name }}'] = true;
                                                } else {
                                                  openConfigs['{{ workflow.name }}'] = false;
                                                  document.getElementById('workflow-{{ workflow.name }}-config').innerHTML = '';
                                                }"
                                        class="flex items-center px-3 py-1 text-sm font-medium rounded-md esevioz-btn-config"
                                        title="Configure workflow">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                    </svg>
                                    Configure
                                </button>
                            </div>
                        </div>
                        
                        <!-- Expandable Configuration Area -->
                        <div id="workflow-{{ workflow.name }}-config" x-show="openConfigs['{{ workflow.name }}']" x-collapse>
                            <!-- Configuration will be loaded here via HTMX when opened -->
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-12 esevioz-card rounded-lg">
                <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.712-3.714M14 40v-4a9.971 9.971 0 01.712-3.714M28 16a4 4 0 11-8 0 4 4 0 018 0zM24 20v6M8 16a4 4 0 11-8 0 4 4 0 018 0zM8 20v6m32-6a4 4 0 11-8 0 4 4 0 018 0zM40 20v6" />
                </svg>
                <h3 class="mt-2 text-sm font-medium esevioz-text">No workflows available</h3>
                <p class="mt-1 text-sm esevioz-text opacity-75">Check your backend connection and configuration.</p>
            </div>
        {% endif %}
    </div>

    <!-- Launch Pad Section -->
    {% if workflows %}
        <div class="mb-8">
            {% include 'partials/workflow_launch_pad.html' %}
        </div>
    {% endif %}

    <!-- Monitoring Section -->
    <div>
        {% include 'partials/workflow_monitor.html' %}
    </div>
</div>
{% endblock %}