{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="{
    openConfigs: {}
}">
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">IO Configuration</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Configure database connections and storage endpoints
        </p>
    </div>

    <!-- Information Section -->
    <div class="mb-6 esevioz-bg border esevioz-border-dominant rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 esevioz-dominant" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm esevioz-text">
                    Database configurations are organized by: <strong>Endpoint → Database Type → Database Kind</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Configuration Kind Filter -->
    {% if supported_kinds %}
        <div class="mb-6">
            <label class="text-sm font-medium esevioz-text">Configuration Source:</label>
            <select id="config-kind-filter"
                    onchange="window.location.href = '{{ url_for('io_config.index') }}?config_kind=' + this.value"
                    class="ml-2 esevioz-input rounded-md shadow-sm text-sm">
                {% for kind in supported_kinds %}
                    <option value="{{ kind }}" {% if config_kind == kind %}selected{% endif %}>
                        {{ kind.replace('_', ' ').title() }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <!-- Database Configurations -->
    {% if configs %}
        <div class="grid gap-6">
            {% for endpoint_config in configs %}
                {% set endpoint_name = endpoint_config.endpoint_name %}
                {% set db_configs = [] %}

                {# Build flat list of database configurations from nested structure #}
                {% for db_type_key, db_type_data in endpoint_config.configuration.items() %}
                    {% if db_type_key.endswith('_db') %}
                        {% set db_type = db_type_key.replace('_db', '') %}
                        {% for db_kind, db_config in db_type_data.items() %}
                            {% set _ = db_configs.append({
                                'db_type': db_type,
                                'db_kind': db_kind,
                                'config': db_config,
                                'endpoint_name': endpoint_name
                            }) %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}

                <div class="esevioz-card esevioz-shadow rounded-lg">
                    <!-- Endpoint Header -->
                    <div class="px-6 py-4 border-b esevioz-border-dominant">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-medium esevioz-text">{{ endpoint_name }}</h3>
                                {% if endpoint_config.configuration.description %}
                                    <p class="mt-1 text-sm esevioz-text opacity-75">{{ endpoint_config.configuration.description }}</p>
                                {% endif %}
                                <p class="{% if endpoint_config.configuration.description %}mt-2{% else %}mt-1{% endif %} text-sm esevioz-text opacity-75">
                                    {{ db_configs|length }} database {{ 'configuration' if db_configs|length == 1 else 'configurations' }}
                                </p>
                                <div class="mt-2 flex items-center space-x-4 text-xs esevioz-text opacity-60">
                                    <!-- Show database types in this endpoint -->
                                    {% set db_types = db_configs | map(attribute='db_type') | list | unique %}
                                    <span>Types: {{ db_types | join(', ') }}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Delete Endpoint Button -->
                                <button type="button"
                                        onclick="deleteEndpoint('{{ endpoint_name }}')"
                                        class="esevioz-btn-delete text-sm font-medium"
                                        title="Delete entire endpoint">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Delete
                                </button>

                                <!-- Expand/Collapse Button -->
                                <button type="button"
                                        @click="if (!openConfigs['{{ endpoint_name }}']) {
                                                  openConfigs['{{ endpoint_name }}'] = true;
                                                } else {
                                                  openConfigs['{{ endpoint_name }}'] = false;
                                                }"
                                        class="flex items-center px-3 py-1 text-sm font-medium rounded-md esevioz-btn-config"
                                        title="Show database configurations">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8"></path>
                                    </svg>
                                    <span x-text="openConfigs['{{ endpoint_name }}'] ? 'Hide' : 'Show'">Show</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Expandable Configuration Grid -->
                    <div x-show="openConfigs['{{ endpoint_name }}']" x-collapse>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for db_config in db_configs %}
                                    {% set config_key = endpoint_name + '-' + db_config['db_type'] + '-' + db_config['db_kind'] %}
                                    <div class="esevioz-db-card rounded-lg p-4">
                                        <!-- Database Type and Kind (Text Only) -->
                                        <div class="text-center mb-4">
                                            <h4 class="text-lg font-medium esevioz-text mb-1">{{ db_config['db_type'] | title }}</h4>
                                            <p class="text-sm esevioz-text opacity-75">{{ db_config['db_kind'] }}</p>
                                        </div>

                                        <!-- Action Button -->
                                        <div>
                                            <!-- View Details Button -->
                                            <button type="button"
                                                    @click="if (!openConfigs['config-{{ config_key }}']) {
                                                              htmx.ajax('GET', '{{ url_for('io_config.view_config_details', endpoint_name=db_config['endpoint_name'], db_type=db_config['db_type'], db_kind=db_config['db_kind'], config_kind=config_kind) }}', {
                                                                target: '#io-config-{{ config_key }}',
                                                                swap: 'innerHTML'
                                                              });
                                                              openConfigs['config-{{ config_key }}'] = true;
                                                            } else {
                                                              openConfigs['config-{{ config_key }}'] = false;
                                                              document.getElementById('io-config-{{ config_key }}').innerHTML = '';
                                                            }"
                                                    class="esevioz-btn-details">
                                                <span x-text="openConfigs['config-{{ config_key }}'] ? 'Hide' : 'Details'">Details</span>
                                            </button>
                                        </div>

                                        <!-- Configuration Panel -->
                                        <div id="io-config-{{ config_key }}" x-show="openConfigs['config-{{ config_key }}']" x-collapse class="mt-4">
                                            <!-- Configuration form will be loaded here via HTMX -->
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8" />
            </svg>
            <h3 class="mt-2 text-sm font-medium esevioz-text">No database configurations</h3>
            <p class="mt-1 text-sm esevioz-text opacity-75">
                No database configurations are available or there was an error loading them.
            </p>
        </div>
    {% endif %}

</div>

<script>
    // Global functions for database configuration operations

    window.deleteEndpoint = function(endpointName) {
        if (confirm(`Are you sure you want to delete the entire endpoint "${endpointName}" and all its database configurations?\n\nThis action cannot be undone.`)) {
            htmx.ajax('DELETE', `/io/endpoint/${endpointName}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(() => {
                // Reload the page to reflect changes
                window.location.reload();
            }).catch((error) => {
                alert('Failed to delete endpoint. Please try again.');
                console.error('Delete error:', error);
            });
        }
    };
</script>
{% endblock %}