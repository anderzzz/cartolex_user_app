{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="{
    expandedEndpoints: {},
    expandedDatabaseTypes: {},
    expandedDatabaseKinds: {},

    toggleEndpoint(endpointName) {
        if (this.expandedEndpoints[endpointName]) {
            this.expandedEndpoints[endpointName] = false;
            // Close all database types when endpoint closes
            Object.keys(this.expandedDatabaseTypes).forEach(key => {
                if (key.startsWith(endpointName + '-')) {
                    this.expandedDatabaseTypes[key] = false;
                }
            });
            // Close all database kinds when endpoint closes
            Object.keys(this.expandedDatabaseKinds).forEach(key => {
                if (key.startsWith(endpointName + '-')) {
                    this.expandedDatabaseKinds[key] = false;
                }
            });
        } else {
            this.expandedEndpoints[endpointName] = true;
            // Load database types if not already loaded
            const typesContainer = document.getElementById('types-' + endpointName);
            if (typesContainer && !typesContainer.hasAttribute('data-loaded')) {
                const url = '/io/' + endpointName + '/types' + (config_kind ? '?config_kind=' + config_kind : '');
                htmx.ajax('GET', url, {
                    target: '#types-' + endpointName,
                    swap: 'innerHTML'
                });
                typesContainer.setAttribute('data-loaded', 'true');
            }
        }
    },

    toggleDatabaseType(endpointName, dbType) {
        const key = endpointName + '-' + dbType;
        if (this.expandedDatabaseTypes[key]) {
            this.expandedDatabaseTypes[key] = false;
            // Close all database kinds for this type
            Object.keys(this.expandedDatabaseKinds).forEach(kindKey => {
                if (kindKey.startsWith(key + '-')) {
                    this.expandedDatabaseKinds[kindKey] = false;
                }
            });
        } else {
            this.expandedDatabaseTypes[key] = true;
            // Load database kinds if not already loaded
            const kindsContainer = document.getElementById('kinds-' + key);
            if (kindsContainer && !kindsContainer.hasAttribute('data-loaded')) {
                const url = '/io/' + endpointName + '/' + dbType + '/kinds' + (config_kind ? '?config_kind=' + config_kind : '');
                htmx.ajax('GET', url, {
                    target: '#kinds-' + key,
                    swap: 'innerHTML'
                });
                kindsContainer.setAttribute('data-loaded', 'true');
            }
        }
    },

    toggleDatabaseKind(endpointName, dbType, dbKind) {
        const key = endpointName + '-' + dbType + '-' + dbKind;
        if (this.expandedDatabaseKinds[key]) {
            this.expandedDatabaseKinds[key] = false;
        } else {
            this.expandedDatabaseKinds[key] = true;
            // Load details if not already loaded
            const detailsContainer = document.getElementById('details-' + key);
            if (detailsContainer && !detailsContainer.hasAttribute('data-loaded')) {
                const url = '/io/' + endpointName + '/' + dbType + '/' + dbKind + '/details' + (config_kind ? '?config_kind=' + config_kind : '');
                htmx.ajax('GET', url, {
                    target: '#details-' + key,
                    swap: 'innerHTML'
                });
                detailsContainer.setAttribute('data-loaded', 'true');
            }
        }
    }
}">
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">IO Configuration</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Configure database connections and storage endpoints
        </p>
    </div>

    <!-- Information Section -->
    <div class="mb-6 esevioz-bg border esevioz-border-dominant rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 esevioz-dominant" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm esevioz-text">
                    Database configurations are organized by: <strong>Endpoint → Database Type → Database Kind</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Configuration Kind Filter -->
    {% if supported_kinds %}
        <div class="mb-6">
            <label class="text-sm font-medium esevioz-text">Configuration Source:</label>
            <select id="config-kind-filter"
                    onchange="window.location.href = '{{ url_for('io_config.index') }}?config_kind=' + this.value"
                    class="ml-2 esevioz-input rounded-md shadow-sm text-sm">
                {% for kind in supported_kinds %}
                    <option value="{{ kind }}" {% if config_kind == kind %}selected{% endif %}>
                        {{ kind.replace('_', ' ').title() }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <!-- Progressive Disclosure Hierarchy -->
    {% if configs %}
        <div class="progressive-disclosure">
            {% for endpoint_config in configs %}
                {% set endpoint_name = endpoint_config.endpoint_name %}
                {% set configuration = endpoint_config.configuration %}

                <!-- Count database types and configurations -->
                {% set db_type_list = [] %}
                {% set total_configs = 0 %}
                {% for db_type_key, db_type_data in configuration.items() %}
                    {% if db_type_key.endswith('_db') and db_type_data is mapping %}
                        {% set db_type = db_type_key.replace('_db', '') %}
                        {% set _ = db_type_list.append(db_type) %}
                        {% set total_configs = total_configs + (db_type_data.keys() | list | length) %}
                    {% endif %}
                {% endfor %}

                <!-- Level 1: Endpoint -->
                <div class="progressive-item-l1">
                    <!-- Endpoint Header -->
                    <div class="progressive-header" @click="toggleEndpoint('{{ endpoint_name }}')">
                        <div class="flex-1">
                            <h3 class="font-semibold esevioz-text">{{ endpoint_name }}</h3>
                            {% if configuration.description %}
                                <p class="mt-1 text-sm esevioz-text opacity-75">{{ configuration.description }}</p>
                            {% endif %}
                            <div class="progressive-meta">
                                <span class="progressive-meta-badge">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8"></path>
                                    </svg>
                                    {{ db_type_list|length }} {{ 'type' if db_type_list|length == 1 else 'types' }}
                                </span>
                                {% if db_type_list %}
                                    <span class="progressive-meta-badge">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                        </svg>
                                        {{ db_type_list | join(', ') }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <svg class="progressive-chevron progressive-chevron-lg"
                             :class="{ 'expanded': expandedEndpoints['{{ endpoint_name }}'] }"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>

                    <!-- Level 2: Database Types Container -->
                    <div x-show="expandedEndpoints['{{ endpoint_name }}']" x-collapse class="progressive-content progressive-content-l1">
                        <div id="types-{{ endpoint_name }}">
                            <!-- Database types will be loaded here via HTMX -->
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8" />
            </svg>
            <h3 class="mt-2 text-sm font-medium esevioz-text">No database configurations</h3>
            <p class="mt-1 text-sm esevioz-text opacity-75">
                No database configurations are available or there was an error loading them.
            </p>
        </div>
    {% endif %}

</div>

<!-- Pass config_kind to JavaScript for HTMX requests -->
<script>
    const config_kind = "{{ config_kind if config_kind else '' }}";
</script>
{% endblock %}