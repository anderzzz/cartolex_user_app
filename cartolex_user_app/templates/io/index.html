{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="{
    openConfigs: {},
    init() {
        // Listen for the close event from the configuration panel
        window.addEventListener('close-io-config', (event) => {
            const configKey = event.detail.configKey;
            this.openConfigs[configKey] = false;
            // Also clear the content
            const configElement = document.getElementById('io-config-' + configKey);
            if (configElement) {
                configElement.innerHTML = '';
            }
        });
    }
}">
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">IO Configuration</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Configure database connections and storage endpoints
        </p>
    </div>

    <!-- Configuration Kind Filter -->
    {% if supported_kinds %}
        <div class="mb-6">
            <label class="text-sm font-medium esevioz-text">Configuration Source:</label>
            <select id="config-kind-filter"
                    onchange="window.location.href = '{{ url_for('io_config.index') }}?config_kind=' + this.value"
                    class="ml-2 esevioz-input rounded-md shadow-sm text-sm">
                {% for kind in supported_kinds %}
                    <option value="{{ kind }}" {% if config_kind == kind %}selected{% endif %}>
                        {{ kind.replace('_', ' ').title() }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <!-- Database Configurations -->
    {% if configs %}
        <div class="grid gap-6">
            {% for endpoint_config in configs %}
                {% set endpoint_name = endpoint_config.endpoint_name %}
                {% set db_configs = [] %}

                {# Build flat list of database configurations from nested structure #}
                {% for db_type_key, db_type_data in endpoint_config.configuration.items() %}
                    {% if db_type_key.endswith('_db') %}
                        {% set db_type = db_type_key.replace('_db', '') %}
                        {% for db_kind, db_config in db_type_data.items() %}
                            {% set _ = db_configs.append({
                                'db_type': db_type,
                                'db_kind': db_kind,
                                'config': db_config,
                                'endpoint_name': endpoint_name
                            }) %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}

                <div class="esevioz-card esevioz-shadow rounded-lg">
                    <!-- Endpoint Header -->
                    <div class="px-6 py-4 border-b esevioz-border-dominant">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-medium esevioz-text">{{ endpoint_name }}</h3>
                                <p class="mt-1 text-sm esevioz-text opacity-75">
                                    {{ db_configs|length }} database {{ 'configuration' if db_configs|length == 1 else 'configurations' }}
                                </p>
                                <div class="mt-2 flex items-center space-x-4 text-xs esevioz-text opacity-60">
                                    <!-- Show database types in this endpoint -->
                                    {% set db_types = db_configs | map(attribute='db_type') | list | unique %}
                                    <span>Types: {{ db_types | join(', ') }}</span>
                                </div>
                            </div>
                            <!-- Expand/Collapse Button -->
                            <button type="button"
                                    @click="if (!openConfigs['{{ endpoint_name }}']) {
                                              openConfigs['{{ endpoint_name }}'] = true;
                                            } else {
                                              openConfigs['{{ endpoint_name }}'] = false;
                                            }"
                                    class="flex items-center px-3 py-1 text-sm font-medium rounded-md esevioz-btn-config"
                                    title="Show database configurations">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8"></path>
                                </svg>
                                <span x-text="openConfigs['{{ endpoint_name }}'] ? 'Hide' : 'Show'">Show</span>
                            </button>
                        </div>
                    </div>

                    <!-- Expandable Configuration Grid -->
                    <div x-show="openConfigs['{{ endpoint_name }}']" x-collapse>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for db_config in db_configs %}
                                    {% set config_key = endpoint_name + '-' + db_config['db_type'] + '-' + db_config['db_kind'] %}
                                    <div class="esevioz-db-card rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center">
                                                <!-- Database Type Icon -->
                                                <div class="w-8 h-8 esevioz-dominant-bg rounded-full flex items-center justify-center mr-3">
                                                    {% if db_config['db_type'] == 'text' %}
                                                        <svg class="w-4 h-4 esevioz-bg" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2v2h8V6H6zm0 4v2h8v-2H6zm0 4v2h5v-2H6z"/>
                                                        </svg>
                                                    {% elif db_config['db_type'] == 'vector' %}
                                                        <svg class="w-4 h-4 esevioz-bg" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                                        </svg>
                                                    {% elif db_config['db_type'] == 'token' %}
                                                        <svg class="w-4 h-4 esevioz-bg" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    {% else %}
                                                        <span class="esevioz-bg font-medium text-xs">
                                                            {{ db_config['db_type'][:2].upper() }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h4 class="text-sm font-medium esevioz-text">{{ db_config['db_type'] | title }} Database</h4>
                                                    <div class="flex items-center space-x-1 mt-1">
                                                        <span class="esevioz-db-badge esevioz-db-badge-{{ db_config['db_type'] }}">{{ db_config['db_type'] }}</span>
                                                        <span class="esevioz-db-badge esevioz-db-kind-{{ db_config['db_kind'] }}">{{ db_config['db_kind'] }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Database Status Preview -->
                                        <div class="text-xs esevioz-text opacity-75 mb-3">
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                                <span>Configuration available</span>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="flex space-x-2">
                                            <!-- View Details Button -->
                                            <button type="button"
                                                    @click="if (!openConfigs['config-{{ config_key }}']) {
                                                              htmx.ajax('GET', '{{ url_for('io_config.view_config_details', endpoint_name=db_config['endpoint_name'], db_type=db_config['db_type'], db_kind=db_config['db_kind'], config_kind=config_kind) }}', {
                                                                target: '#io-config-{{ config_key }}',
                                                                swap: 'innerHTML'
                                                              });
                                                              openConfigs['config-{{ config_key }}'] = true;
                                                            } else {
                                                              openConfigs['config-{{ config_key }}'] = false;
                                                              document.getElementById('io-config-{{ config_key }}').innerHTML = '';
                                                            }"
                                                    class="flex-1 esevioz-btn-config-db">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <span x-text="openConfigs['config-{{ config_key }}'] ? 'Hide' : 'Details'">Details</span>
                                            </button>

                                            <!-- Create From Button -->
                                            <button type="button"
                                                    onclick="createFromConfig('{{ db_config['endpoint_name'] }}', '{{ db_config['db_type'] }}', '{{ db_config['db_kind'] }}')"
                                                    class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                                                    title="Create new configuration based on this one">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </button>

                                            <!-- Delete Button -->
                                            <button type="button"
                                                    onclick="deleteConfig('{{ db_config['endpoint_name'] }}', '{{ db_config['db_type'] }}', '{{ db_config['db_kind'] }}')"
                                                    class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors"
                                                    title="Delete this configuration">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>

                                        <!-- Configuration Panel -->
                                        <div id="io-config-{{ config_key }}" x-show="openConfigs['config-{{ config_key }}']" x-collapse class="mt-4">
                                            <!-- Configuration form will be loaded here via HTMX -->
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0 2.21 3.582 4 8 4s8-1.79 8-4V7m0 0c0-2.21 3.582-4 8-4s8 1.79 8 4v5M28 7h8" />
            </svg>
            <h3 class="mt-2 text-sm font-medium esevioz-text">No database configurations</h3>
            <p class="mt-1 text-sm esevioz-text opacity-75">
                No database configurations are available or there was an error loading them.
            </p>
        </div>
    {% endif %}

    <!-- Configuration Info -->
    <div class="mt-8 esevioz-bg border esevioz-border-highlight rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 esevioz-highlight" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium esevioz-highlight">Configuration Hierarchy</h3>
                <div class="mt-2 text-sm esevioz-text">
                    <p>Database configurations are organized by: <strong>Endpoint</strong> → <strong>Database Type</strong> → <strong>Database Kind</strong></p>
                    <div class="mt-2 flex items-center space-x-4 text-xs">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-1"></div>
                            <span>Text databases store document content</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-1"></div>
                            <span>Vector databases store embeddings</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-purple-500 rounded-full mr-1"></div>
                            <span>Token databases store authentication</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global functions for database configuration operations
    window.createFromConfig = function(endpointName, dbType, dbKind) {
        // Navigate to create page with template parameters
        window.location.href = `/io/create?template_endpoint=${endpointName}&template_db_type=${dbType}&template_db_kind=${dbKind}`;
    };

    window.deleteConfig = function(endpointName, dbType, dbKind) {
        if (confirm(`Are you sure you want to delete the ${dbType} ${dbKind} configuration for ${endpointName}?\n\nThis action cannot be undone.`)) {
            htmx.ajax('DELETE', `/io/${endpointName}/${dbType}/${dbKind}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(() => {
                // Reload the page to reflect changes
                window.location.reload();
            }).catch((error) => {
                alert('Failed to delete configuration. Please try again.');
                console.error('Delete error:', error);
            });
        }
    };
</script>
{% endblock %}