{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="{
    openConfigs: {}
}">
    <!-- Header -->
    <div class="border-b esevioz-border-dominant pb-4 mb-6">
        <h2 class="text-2xl font-bold leading-7 esevioz-text">Semantics Configuration</h2>
        <p class="mt-2 text-sm esevioz-text opacity-75">
            Inspect and configure semantic models
        </p>
    </div>

    <!-- Information Section -->
    <div class="mb-6 esevioz-bg border esevioz-border-dominant rounded-md p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 esevioz-dominant" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm esevioz-text">
                    Semantics configurations are organized by: <strong>Endpoint → Provider → Tier</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Configuration Kind Filter -->
    {% if supported_kinds %}
        <div class="mb-6">
            <label class="text-sm font-medium esevioz-text">Configuration Source:</label>
            <select id="config-kind-filter"
                    onchange="window.location.href = '{{ url_for('semantics.index') }}?config_kind=' + this.value"
                    class="ml-2 esevioz-input rounded-md shadow-sm text-sm">
                {% for kind in supported_kinds %}
                    <option value="{{ kind }}" {% if config_kind == kind %}selected{% endif %}>
                        {{ kind.replace('_', ' ').title() }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <!-- Semantics Configuration Endpoints -->
    {% if configs %}
        <div class="grid gap-6">
            {% for endpoint_config in configs %}
                {% set endpoint_name = endpoint_config.endpoint_name %}
                {% set configuration = endpoint_config.configuration %}

                <!-- Count providers and configurations -->
                {% set provider_list = [] %}
                {% set total_configs = 0 %}
                {% for provider, tiers in configuration.items() %}
                    {% if tiers is mapping and not provider.startswith('_') and provider != 'description' %}
                        {% set _ = provider_list.append(provider) %}
                        {% set total_configs = total_configs + (tiers.keys() | list | length) %}
                    {% endif %}
                {% endfor %}

                <div class="esevioz-card esevioz-shadow rounded-lg">
                    <!-- Endpoint Header -->
                    <div class="px-6 py-4 border-b esevioz-border-dominant">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-medium esevioz-text">{{ endpoint_name }}</h3>
                                {% if configuration.description %}
                                    <p class="mt-1 text-sm esevioz-text opacity-75">{{ configuration.description }}</p>
                                {% endif %}
                                <p class="{% if configuration.description %}mt-2{% else %}mt-1{% endif %} text-sm esevioz-text opacity-75">
                                    {{ provider_list|length }} {{ 'provider' if provider_list|length == 1 else 'providers' }},
                                    {{ total_configs }} {{ 'configuration' if total_configs == 1 else 'configurations' }}
                                </p>
                                <div class="mt-2 flex items-center space-x-4 text-xs esevioz-text opacity-60">
                                    <!-- Show providers in this endpoint -->
                                    <span>Providers: {{ provider_list | join(', ') }}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Expand/Collapse Button -->
                                <button type="button"
                                        @click="if (!openConfigs['{{ endpoint_name }}']) {
                                                  openConfigs['{{ endpoint_name }}'] = true;
                                                } else {
                                                  openConfigs['{{ endpoint_name }}'] = false;
                                                }"
                                        class="flex items-center px-3 py-1 text-sm font-medium rounded-md esevioz-btn-config"
                                        title="Show provider configurations">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                    <span x-text="openConfigs['{{ endpoint_name }}'] ? 'Hide' : 'Show'">Show</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Expandable Provider Grid -->
                    <div x-show="openConfigs['{{ endpoint_name }}']" x-collapse>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for provider, tiers in configuration.items() %}
                                    {% if tiers is mapping and not provider.startswith('_') and provider != 'description' %}
                                        {% set config_key = endpoint_name + '-' + provider %}
                                        <div class="esevioz-db-card rounded-lg p-4">
                                            <!-- Provider Name -->
                                            <div class="text-center mb-4">
                                                <h4 class="text-lg font-medium esevioz-text mb-1">{{ provider | title }}</h4>
                                                <p class="text-sm esevioz-text opacity-75">{{ tiers.keys() | list | length }} tier{{ 's' if (tiers.keys() | list | length) != 1 else '' }}</p>
                                            </div>

                                            <!-- Action Button -->
                                            <div>
                                                <!-- View Details Button -->
                                                <button type="button"
                                                        @click="if (!openConfigs['config-{{ config_key }}']) {
                                                                  htmx.ajax('GET', '{{ url_for('semantics.provider_configs', endpoint_name=endpoint_name, provider=provider) }}{{ '?config_kind=' + config_kind if config_kind else '' }}', {
                                                                    target: '#semantics-config-{{ config_key }}',
                                                                    swap: 'innerHTML'
                                                                  });
                                                                  openConfigs['config-{{ config_key }}'] = true;
                                                                } else {
                                                                  openConfigs['config-{{ config_key }}'] = false;
                                                                  document.getElementById('semantics-config-{{ config_key }}').innerHTML = '';
                                                                }"
                                                        class="esevioz-btn-details">
                                                    <span x-text="openConfigs['config-{{ config_key }}'] ? 'Hide' : 'Details'">Details</span>
                                                </button>
                                            </div>

                                            <!-- Configuration Panel -->
                                            <div id="semantics-config-{{ config_key }}" x-show="openConfigs['config-{{ config_key }}']" x-collapse class="mt-4">
                                                <!-- Configuration details will be loaded here via HTMX -->
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 esevioz-text opacity-50" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <h3 class="mt-2 text-sm font-medium esevioz-text">No semantics configurations</h3>
            <p class="mt-1 text-sm esevioz-text opacity-75">
                No semantics configurations are available or there was an error loading them.
            </p>
        </div>
    {% endif %}

</div>
{% endblock %}